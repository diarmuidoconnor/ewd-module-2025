## ALB-EC2 stack

---

**Note: You are not required to submit this lab for assessment. Nevertheless, the CDK framework is a central part of this module, and we will be using it throughout, so it is essential to get it setup.**

---

Our objective is to deploy the following application stack to your AWS account using the CDK framework:

![][schema]

The EC2 instance will host a simple web server that displays a Hello World web page.
This infrastructure configuration is sophisticated (it includes an Application Load Balancer, Auto Scaling Group, etc.), but it's based on traditional architecture, i.e. it's not serverless-based. For this reason, we need not delve into HOW the infrastructure works but instead appreciate WHAT is possible with the Infrastructure as Code technique.

The code for this stack can be cloned from [here](https://github.com/diarmuidoconnor/cdk-alb-ec2-demo)

> > $ git clone https://github.com/diarmuidoconnor/cdk-alb-ec2-demo

Import the `cdk-alb-ec2-demo` folder into VS Code, open an integrated terminal, and install the dependencies:

```bash
$ npm install
```

The infrastructure for this application is defined in the `lib/cdk-stack.ts` file. You can scan over its code, but it is not necessary to understand it fully at this stage.

To deploy the stack to your AWS account, type the command:

```bash
$ cdk deploy
```

[Include the --profile option if relevant.]

Assuming the deployment was successful, the terminal output includes the domain name of the newly created Application Load Balancer resource:

![][alb]

Copy the domain name and paste it into a browser tab:

![][root]

[**If you get a 504 Bad Gateway Error response, then skip to the Alternative Stack section below.**]

The above response confirms the web server is running inside the EC2 instances. The web page displays a Hello World message followed by the server's hostname, which includes the private IP address of the EC2 instance. Hit refresh a few times and notice the hostname alternates between two IP addresses - see `lib/user-data.sh`. Our stack provisioned two EC@ instances, and the Application Load Balancer distributed the requests between the two targets.

In the AWS management console, check the stack deployment in CloudFormation:

![][cf]

The stack is comprised of several resources, for example:

- Two EC2 instance.
- An Application load balancer (ALB), with one listener on port 60.
- An Auto Scaling group (ASG) for scaling the EC2 instance. The ASG is the target for the ALB listener.
- A Security group for the EC2 instance(s), with one ingress rule.

Use the management console to find these resources, for example:

![][ec2]

![][albmc]

### Infrastructure State Management.

In the management console, go to the EC2 console and click 'Security Groups' on the left panel. In the list of groups displayed, find the group with 'cdk-stack-webserversg' in its name. This security group currently has one inbound rule defined.

![][secgrp]

To demonstrate the state management feature of the CDK framework (and, by implication, CloudFormation's support for state management), in VS Code, open the file `lib/cdk-stack.ts` and uncomment the lines:

```ts
serverSG.addIngressRule(
 Peer.anyIpv4(),
 Port.tcp(22),
  "allow SSH access from anywhere"
);
```

This code adds a second rule to the security group of the server (EC2 instances). Now update the stack's state by redeploying the app using the same command:

```bash
$ cdk deploy
```

[Include the --profile option if relevant.]

Type y to allow CloudFormation to apply the changes to your deployed resources.

When the deployment is complete, recheck the security group in the AWS management console to confirm the **state change** has occurred:

![][secgrp2]

Change the same lines of code back to comments again and rerun the deploy command. CloudFormation will update the state by removing the rule from the inbound list.

### Alternative Stack.

Sometimes the Application Load Balancer in our stack reports a 504 Bad Gateway error. The error may be due to a startup sequencing problem, but as we will not be using the EC2 for the rest of this module, it is not necessary to debug the issue. To satisfy our desire to get a CDK stack working before progressing, we will declare a simpler infrastructure architecture: a standalone EC2 with a Web server installed, and a security group that allows HTTP access.

Destroy the current stack:
```bash
$ cdk destroy
```
Replace the code in `lib/cdk-stack.ts` with the following:
~~~
import * as cdk from "aws-cdk-lib";
import { Construct } from "constructs";
import * as ec2 from "aws-cdk-lib/aws-ec2";

export class CdkStack extends cdk.Stack {
 constructor(scope: Construct, id: string, props?: cdk.StackProps) {
 super(scope, id, props);

 const defaultVpc = ec2.Vpc.fromLookup(this, "VPC", { isDefault: true });
    
 const userData = ec2.UserData.forLinux();
 userData.addCommands(
 'sudo su',
 'yum install -y httpd',
 'systemctl start httpd',
 'systemctl enable httpd',
 'echo "<h1>Hello World from $(hostname -f)</h1>" > /var/www/html/index.html',
 );

 const serverSG = new ec2.SecurityGroup(this, "webserver-sg", {
 vpc: defaultVpc,
 allowAllOutbound: true,
 });
    
 serverSG.addIngressRule(
 ec2.Peer.anyIpv4(),
 ec2.Port.tcp(80),
 "allow HTTP access from anywhere"
 );
    
 const ec2Instance = new ec2.Instance(this, "ec2-instance", {
 vpc: defaultVpc,
 securityGroup: serverSG,
 instanceType: ec2.InstanceType.of(
 ec2.InstanceClass.BURSTABLE2,
 ec2.InstanceSize.MICRO
 ),
 machineImage: new ec2.AmazonLinuxImage({
 generation: ec2.AmazonLinuxGeneration.AMAZON_LINUX_2,
 }),
 userData
 });

 new cdk.CfnOutput(this, 'EC2 Public DNS', {
 value: ec2Instance.instancePublicDnsName ,
 });
 }
}
~~~

Deploy this new stack:
```bash
$ cdk deploy
```

The terminal response shows the DNS name for the EC2 instance. Copy this into a browser tab:

![][alternative]


[schema]: ./img/schema.png
[alb]: ./img/alb.png
[root]: ./img/root.png
[api]: ./img/api.png
[cf]: ./img/cf.png
[secgrp]: ./img/secgrp.png
[secgrp2]: ./img/secgrp2.png
[albmc]: ./img/albmc.png
[ec2]: ./img/ec2.png
[alternative]: ./img/alternative.png
